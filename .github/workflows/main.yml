# main branchì— push, pull requestê°€ ë°œìƒí•  ë•Œ ì‹¤í–‰
on:
  pull_request:
    branches:
      - main

env:
  # ë„ì»¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë° ì´ë¯¸ì§€ ì •ë³´, ì»¨í…Œì´ë„ˆ ì´ë¦„
  REGISTRY: ghcr.io
  DOCKER_IMAGE: ${{ github.repository }}
  DOCKER_CONTAINER: server

jobs:
  # í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‹¤í–‰
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Use Node.js 18.x
        uses: actions/setup-node@v2
        with:
          node-version: 18.x

      - name: npm install
        run: npm install

      - name: npm test
        run: npm test

      - name: npm run build
        run: npm run build

      - name: if build fail, close pr request
        if: failure()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GIT_TOKEN }}
          script: |
            const pull_number = context.payload.pull_request.number;
            const updated_title = `ğŸš¨ [WIP] ${context.payload.pull_request.title}`;

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number,
              body: 'í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ ì‹¤íŒ¨ë¡œ ì¸í•´, ë¨¸ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
              event: 'REQUEST_CHANGES',
            });

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number,
              title: updated_title,
              state: 'closed',
            });

  # í…ŒìŠ¤íŠ¸ ì„±ê³µì‹œ, ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v2

      - name: Set up docker build
        id: buildx
        uses: docker/setup-buildx-action@v1

      - name: Login To ghcr
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GIT_TOKEN }}

      - name: Build and Push
        id: docker_build
        uses: docker/build-push-action@v2
        with:
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.DOCKER_IMAGE }}:latest

  # ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ì„±ê³µì‹œ,
  deploy:
    needs: build

    runs-on: ubuntu-latest

    steps:
      - name: checkout source code
        uses: actions/checkout@v2

      - name: deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          port: ${{ secrets.REMOTE_PORT }}
          password: ${{ secrets.REMOTE_PASSWORD }}
          script: |
            docker stop ${{ env.DOCKER_CONTAINER }} || true
            docker rm ${{ env.DOCKER_CONTAINER }} || true
            docker rmi ${{ env.REGISTRY }}/${{ env.DOCKER_IMAGE }}:latest || true

            docker login ${{ env.REGISTRY }} -u ${{ github.actor }} -p ${{ secrets.GIT_TOKEN }}
            docker pull ${{ env.REGISTRY }}/${{ env.DOCKER_IMAGE }}:latest
            docker run -d \
              -p 3000:3000 \
              -p 443:443 \
              --name ${{ env.DOCKER_CONTAINER }} \
              --restart=always \
              ${{ env.REGISTRY }}/${{ env.DOCKER_IMAGE }}:latest
